<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Generate SQL Pindah Massal</title>
  <style>
    body{font-family:Arial;padding:20px;max-width:800px}
    .card{border:1px solid #ddd;padding:12px;border-radius:6px;margin-bottom:12px}
    button{padding:8px 12px;cursor:pointer}
  </style>
</head>
<body>
  <h3>Generate SQL: Pindah Massal Pen</h3>

  <div class="card">
    <label><strong>Pen Tujuan</strong></label><br/>
    <input id="penTujuan" type="text" placeholder="contoh: PEN-UTAMA-01" style="width:100%;padding:8px;margin-top:6px"/>
  </div>

  <div class="card">
    <strong>Pilih Pen Sementara</strong><br/>
    <label><input type="checkbox" class="pen" value="DF1" checked/> DF1</label><br/>
    <label><input type="checkbox" class="pen" value="DF2" checked/> DF2</label><br/>
    <label><input type="checkbox" class="pen" value="DF3" checked/> DF3</label><br/>
    <label><input type="checkbox" class="pen" value="DJ1" checked/> DJ1</label><br/>
    <label><input type="checkbox" class="pen" value="DJ2" checked/> DJ2</label><br/>
  </div>

  <div style="display:flex;gap:8px">
    <button id="btnGenerate">Generate SQL</button>
    <button id="btnPreview">Preview Query</button>
  </div>

  <pre id="preview" style="background:#f7f7f7;padding:12px;margin-top:12px;white-space:pre-wrap"></pre>

  <script>
    function buildSql(pens, penTujuan) {
      // Jika ingin update per id_sapi, frontend bisa generate SELECT dulu (tidak bisa akses DB)
      // Kita buat UPDATE massal berdasarkan pen
      const pensEscaped = pens.map(p => `'${p.replace(/'/g,"''")}'`).join(', ');
      return `-- Backup dulu sebelum menjalankan\nSTART TRANSACTION;\n\nUPDATE induksi\nSET pen = '${penTujuan.replace(/'/g,"''")}'\nWHERE pen IN (${pensEscaped});\n\n-- Verifikasi\nSELECT pen, COUNT(*) AS jumlah FROM induksi WHERE pen = '${penTujuan.replace(/'/g,"''")}' GROUP BY pen;\n\nCOMMIT;`;
    }

    document.getElementById('btnPreview').addEventListener('click', () => {
      const penTujuan = document.getElementById('penTujuan').value.trim();
      const pens = Array.from(document.querySelectorAll('.pen:checked')).map(i=>i.value);
      if (!penTujuan) { alert('Isi pen tujuan'); return; }
      if (pens.length===0) { alert('Pilih minimal satu pen sementara'); return; }
      document.getElementById('preview').innerText = buildSql(pens, penTujuan);
    });

    document.getElementById('btnGenerate').addEventListener('click', () => {
      const penTujuan = document.getElementById('penTujuan').value.trim();
      const pens = Array.from(document.querySelectorAll('.pen:checked')).map(i=>i.value);
      if (!penTujuan) { alert('Isi pen tujuan'); return; }
      if (pens.length===0) { alert('Pilih minimal satu pen sementara'); return; }

      const sql = buildSql(pens, penTujuan);
      const blob = new Blob([sql], { type: 'text/sql' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `pindah_pen_${pens.join('-')}_to_${penTujuan}.sql`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      alert('File SQL telah dibuat. Berikan ke DBA untuk dieksekusi.');
    });
  </script>
</body>
</html>
